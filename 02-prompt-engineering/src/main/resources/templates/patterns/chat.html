<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Turn Chat</title>
    <link rel="stylesheet" th:href="@{/css/prompt-demo.css}">
</head>
<body>
    <div class="container">
        <div class="demo-page">
            <a th:href="@{/}" class="back-link">‚Üê Back to Dashboard</a>
            
            <div class="demo-header">
                <span class="icon">üí¨</span>
                <div class="demo-title">
                    <h1>Multi-Turn Chat</h1>
                    <p>Context preservation across multiple messages</p>
                </div>
            </div>

            <div class="demo-section">
                <h2>Conversation</h2>
                <div id="session-info" class="session-info" style="display: none;">
                    Session ID: <span id="session-id"></span>
                    <button onclick="clearChat()" class="btn-copy" style="float: right;">Clear Chat</button>
                </div>

                <div id="chat-container" class="chat-container">
                    <p style="text-align: center; color: #9ca3af;">No messages yet. Start chatting below!</p>
                </div>

                <div class="input-group">
                    <label for="message">Your message:</label>
                    <textarea id="message" placeholder="What is Spring Boot?"></textarea>
                </div>

                <div class="examples">
                    <button class="example-btn" onclick="setExample('What is Spring Boot?')">Ask about Spring</button>
                    <button class="example-btn" onclick="setExample('Show me an example')">Request example</button>
                    <button class="example-btn" onclick="setExample('How does it compare to Node.js?')">Compare</button>
                </div>

                <div class="button-group">
                    <button id="submit-btn" class="btn" onclick="sendMessage()">Send Message</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Waiting for response...</p>
            </div>

            <div class="demo-section" style="margin-top: 40px;">
                <h2>When to Use</h2>
                <ul>
                    <li>Interactive assistants and chatbots</li>
                    <li>Multi-turn conversations requiring context</li>
                    <li>Q&A sessions where follow-up questions are common</li>
                    <li>When conversation history influences responses</li>
                </ul>
            </div>
        </div>
    </div>

    <script th:src="@{/js/pattern-demo.js}"></script>
    <script>
        let sessionId = null;

        async function sendMessage() {
            const message = document.getElementById('message').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Generate session ID if first message
            if (!sessionId) {
                sessionId = 'session-' + Date.now();
                document.getElementById('session-id').textContent = sessionId;
                document.getElementById('session-info').style.display = 'block';
            }

            // Add user message to chat
            addMessage('user', message);
            document.getElementById('message').value = '';

            const loadingDiv = document.getElementById('loading');
            const submitBtn = document.getElementById('submit-btn');

            try {
                loadingDiv.style.display = 'block';
                submitBtn.disabled = true;

                const response = await fetch('/api/gpt5/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message, sessionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                addMessage('assistant', data.result || data.response);

            } catch (error) {
                addMessage('assistant', 'Error: ' + error.message);
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function addMessage(role, content) {
            const container = document.getElementById('chat-container');
            
            // Remove empty state
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function clearChat() {
            if (!sessionId) return;

            if (confirm('Clear this conversation?')) {
                try {
                    await fetch(`/api/gpt5/chat/${sessionId}`, { method: 'DELETE' });
                } catch (error) {
                    console.error('Failed to clear session:', error);
                }
                
                sessionId = null;
                document.getElementById('session-info').style.display = 'none';
                document.getElementById('chat-container').innerHTML = 
                    '<p style="text-align: center; color: #9ca3af;">No messages yet. Start chatting below!</p>';
            }
        }
    </script>
</body>
</html>
